version: '3.8'

services:
  # --- THE FOREMAN (Coordination & SIP Bridge) ---
  asterisk:
    image: agentvoiceresponse/avr-asterisk:latest
    container_name: gauntlet-foreman
    ports:
      - "5060:5060/udp" # SIP Signaling
      - "10000-10100:10000-10100/udp" # RTP Audio Stream
      - "9092:9092" # AudioSocket Bridge
    volumes:
      - ./config/asterisk:/etc/asterisk
    networks:
      - dojo-mesh

  triage-api:
    build:
      context: ./services/foreman
    container_name: gauntlet-foreman-triage
    environment:
      - LEARNING_REPO_URL=http://learning-repo:5000/check-number
      - PORT=8080
    networks:
      - dojo-mesh

  # --- THE ACTOR (Local AI Inference via Ollama) ---
  ollama:
    image: ollama/ollama:latest
    container_name: gauntlet-actor
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - dojo-mesh

  # --- THE ARCHITECT (Voice Processing & Deepfake Detection) ---
  architect:
    build:
      context: ./services/architect
    container_name: gauntlet-architect
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - ACTOR_HOST=http://actor:8000
    volumes:
      - ./services/architect/observer_prompt.txt:/app/prompts/observer_prompt.txt
      - ./learning_repo/models:/app/models
    depends_on:
      - ollama
      - actor
    networks:
      - dojo-mesh

  # --- THE ACTOR (Method Actor Service) ---
  actor:
    build:
      context: ./services/actor
    container_name: gauntlet-actor-service
    environment:
      - OLLAMA_URL=http://ollama:11434
      - DEFAULT_PERSONA=hazel
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - AUDIOSOCKET_PORT=9092
    depends_on:
      - ollama
    ports:
      - "9092:9092"
    networks:
      - dojo-mesh

  # --- THE AUDITOR (AEAD Masking & Learning Repo) ---
  learning-repo:
    build:
      context: ./services/auditor
    container_name: gauntlet-auditor
    volumes:
      - ./learning_repo:/data/vault
      - ./logs:/var/log/gauntlet
    networks:
      - dojo-mesh

  # --- THE BRIDGE (ElevenLabs Voice Synthesis & WebSocket Relay) ---
  bridge:
    build:
      context: ./services/bridge
    container_name: gauntlet-bridge
    ports:
      - "8000:8000" # WebSocket + REST API
    environment:
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
      - ELEVENLABS_VOICE_ID=${ELEVENLABS_VOICE_ID:-}
      - ELEVENLABS_MODEL_ID=${ELEVENLABS_MODEL_ID:-eleven_monolingual_v1}
      - OLLAMA_URL=http://ollama:11434
      - ACTOR_HOST=http://actor:8000
      - FOREMAN_HOST=http://triage-api:8080
      - STEWARD_HOST=http://steward:8080
    depends_on:
      - ollama
      - actor
      - triage-api
      - steward
    networks:
      - dojo-mesh

  # --- THE STEWARD (Gamification & Credits) ---
  steward:
    build:
      context: ./services/steward
    container_name: gauntlet-steward
    ports:
      - "8080:8080" # Steward API + Dashboard
    environment:
      - DB_PATH=/data/vault/steward.db
      - PORT=8080
    volumes:
      - ./learning_repo:/data/vault
    networks:
      - dojo-mesh

networks:
  dojo-mesh:
    driver: bridge

volumes:
  ollama_data:
